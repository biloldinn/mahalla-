<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TURON O'QUV MARKAZI - AI Test Tizimi</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Screen Mirror CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmirror@1.0.0/jsmirror.css">

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --ai-color: #a855f7;
            --info: #0ea5e9;
            --dark: #1e293b;
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #e0e7ff 0%, #f8fafc 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--dark);
        }

        /* Login Section */
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            padding: 40px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow);
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Admin Login Button */
        .admin-login-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--danger);
            color: white;
            border-radius: 50px;
            padding: 10px 20px;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
            z-index: 1000;
            border: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .admin-login-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
        }

        /* Test Cards */
        .test-card {
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .test-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .test-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
        }

        .ai-test-header {
            background: linear-gradient(135deg, var(--ai-color), #6a11cb);
            color: white;
            padding: 15px;
        }

        /* Timer */
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: var(--danger);
            padding: 10px 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid var(--danger);
            text-align: center;
            min-width: 120px;
        }

        /* Admin Panel */
        .admin-sidebar {
            width: 280px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: var(--dark);
            color: white;
            padding-top: 30px;
            overflow-y: auto;
            z-index: 100;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
        }

        .admin-content {
            margin-left: 280px;
            padding: 40px;
            min-height: 100vh;
            background: #f8fafc;
        }

        .nav-link-admin {
            display: flex;
            align-items: center;
            padding: 14px 24px;
            margin: 4px 16px;
            color: #94a3b8;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            font-weight: 500;
        }

        .nav-link-admin i {
            margin-right: 12px;
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .nav-link-admin:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            transform: translateX(5px);
        }

        .nav-link-admin.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .nav-link-admin.ai {
            background: linear-gradient(45deg, var(--ai-color), #8b5cf6);
            color: white;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        /* Student Panel */
        .student-nav {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Question Box */
        .question-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
        }

        .ai-question-box {
            border-left: 4px solid var(--ai-color);
        }

        .option-label {
            display: block;
            padding: 12px 15px;
            margin: 8px 0;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-label:hover {
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .option-label.selected {
            border-color: var(--success);
            background: #d4edda;
            color: var(--success);
        }

        /* Result Card - Premium Enhancement */
        .result-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: var(--dark);
            padding: 50px 40px;
            border-radius: 32px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, var(--primary), var(--ai-color));
        }

        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 48px;
            font-weight: 800;
            color: white;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            background: conic-gradient(var(--primary) var(--percentage), #e2e8f0 0);
            position: relative;
            animation: scaleIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .score-circle::after {
            content: attr(data-score);
            position: absolute;
            width: 155px;
            height: 155px;
            background: var(--dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .score-circle span {
            position: relative;
            z-index: 2;
            background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Grade Badges */
        .grade-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .grade-5 {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            color: white;
        }

        .grade-4 {
            background: linear-gradient(45deg, #94a3b8, #64748b);
            color: white;
        }

        .grade-3 {
            background: linear-gradient(45deg, #d97706, #b45309);
            color: white;
        }

        .grade-2 {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }

        .grade-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        /* Review Section Enhancement */
        .review-q-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }

        .review-q-card:hover {
            transform: translateX(5px);
            border-color: var(--primary);
        }

        .review-q-card.correct {
            border-left: 5px solid var(--success);
        }

        .review-q-card.incorrect {
            border-left: 5px solid var(--danger);
        }

        /* Stat Cards */
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--primary);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .ai-stat-card {
            border-left: 5px solid var(--ai-color);
        }

        /* Badges */
        .badge-ai {
            background: var(--ai-color);
            color: white;
        }

        .btn-ai {
            background: linear-gradient(45deg, var(--ai-color), #8b5cf6);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        .btn-ai:hover {
            background: linear-gradient(45deg, #9333ea, #7c3aed);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.4);
        }

        .btn-primary {
            background-color: var(--primary);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
        }

        .bg-ai {
            background: var(--ai-color);
        }

        /* File Upload Zone */
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .drop-zone:hover {
            border-color: var(--ai-color);
            background: #e8f4fc;
        }

        .drop-zone.active {
            border-color: var(--ai-color);
            background: #e8f4fc;
        }

        /* Live Monitoring */
        .monitoring-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .student-monitor {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .student-monitor:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .student-monitor.active {
            border-left: 4px solid var(--success);
            background: linear-gradient(to right, #f0fdf4, white);
        }

        .student-monitor.finished {
            border-left: 4px solid var(--info);
            background: linear-gradient(to right, #f0f9ff, white);
        }

        .progress-time {
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-time-bar {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        /* Screen Mirror */
        .screen-mirror-container {
            background: var(--dark);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .screen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .screen-item {
            background: #0f172a;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .screen-header {
            background: rgba(255, 255, 255, 0.05);
            color: #f8fafc;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .screen-content {
            padding: 20px;
            background: #020617;
            color: #38bdf8;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 13px;
            height: 220px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .screen-content::-webkit-scrollbar {
            width: 4px;
        }

        .screen-content::-webkit-scrollbar-thumb {
            background: rgba(56, 189, 248, 0.3);
            border-radius: 2px;
        }

        /* Modal Custom */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            border-radius: 15px 15px 0 0;
            padding: 15px 20px;
        }

        /* Loading Spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        /* Alert Animations */
        .alert {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .admin-sidebar.active {
                transform: translateX(0);
            }

            .admin-content {
                margin-left: 0;
                padding: 15px;
            }

            .timer {
                font-size: 18px;
                padding: 8px 15px;
                min-width: 100px;
            }

            .screen-grid {
                grid-template-columns: 1fr;
            }

            .admin-login-btn {
                bottom: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 12px;
            }
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }

            .section.active {
                display: block !important;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Utility Classes */
        .cursor-pointer {
            cursor: pointer;
        }

        .text-ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shadow-hover {
            transition: box-shadow 0.3s;
        }

        .shadow-hover:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Animation for AI Processing */
        .ai-pulse {
            animation: aiPulse 2s infinite;
        }

        @keyframes aiPulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <!-- Admin Login Button -->
    <button class="admin-login-btn no-print" onclick="showAdminLoginModal()">
        <i class="fas fa-lock"></i> Admin Panel
    </button>

    <!-- Login Section -->
    <div id="loginSection" class="section active">
        <div class="container">
            <div class="login-container">
                <div class="text-center mb-4">
                    <i class="fas fa-graduation-cap fa-3x text-primary mb-3"></i>
                    <h2>Turon O'quv Markazi</h2>
                    <p class="text-muted">AI Test Tizimiga xush kelibsiz</p>
                </div>

                <div id="studentLoginForm">
                    <div class="mb-3">
                        <label class="form-label">Telefon raqam</label>
                        <input type="tel" class="form-control" id="studentPhone" placeholder="+998901234567">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parol</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="studentPassword">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="togglePassword('studentPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mb-3" onclick="loginStudent()">
                        <i class="fas fa-sign-in-alt"></i> Kirish
                    </button>
                    <p class="text-center mb-0">
                        Yangi o'quvchimisiz?
                        <a href="#" class="text-decoration-none" onclick="showRegister()">Ro'yxatdan o'ting</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Section -->
    <div id="registerSection" class="section">
        <div class="container">
            <div class="login-container">
                <div class="text-center mb-4">
                    <h3>Ro'yxatdan o'tish</h3>
                    <p class="text-muted">Ma'lumotlaringizni kiriting</p>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-3" id="regFirstName" placeholder="Ism">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-3" id="regLastName" placeholder="Familiya">
                    </div>
                </div>

                <div class="mb-3">
                    <input type="tel" class="form-control" id="regPhone" placeholder="Telefon raqam (+998901234567)">
                </div>

                <div class="mb-3">
                    <input type="text" class="form-control" id="regGroup" placeholder="Guruh kodi (232)">
                </div>

                <div class="mb-3">
                    <div class="input-group">
                        <input type="password" class="form-control" id="regPassword"
                            placeholder="Parol (kamida 6 ta belgi)">
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('regPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="input-group">
                        <input type="password" class="form-control" id="regConfirmPassword"
                            placeholder="Parolni takrorlang">
                        <button class="btn btn-outline-secondary" type="button"
                            onclick="togglePassword('regConfirmPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <button class="btn btn-success w-100 mb-3" onclick="registerStudent()">
                    <i class="fas fa-user-plus"></i> Ro'yxatdan o'tish
                </button>

                <button class="btn btn-outline-secondary w-100" onclick="showLogin()">
                    <i class="fas fa-arrow-left"></i> Kirish sahifasiga
                </button>
            </div>
        </div>
    </div>

    <!-- Student Dashboard -->
    <div id="studentSection" class="section">
        <nav class="student-nav">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0"><i class="fas fa-graduation-cap text-primary"></i> Turon O'quvchi</h4>
                        <small id="studentInfo" class="text-muted"></small>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="showStudentTests()">
                            <i class="fas fa-list"></i> Testlar
                        </button>
                        <button class="btn btn-outline-success me-2" onclick="showStudentResults()">
                            <i class="fas fa-chart-bar"></i> Natijalarim
                        </button>
                        <button class="btn btn-outline-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Chiqish
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container">
            <div id="studentContent">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminSection" class="section">
        <div class="admin-sidebar no-print">
            <div class="text-center mb-4 px-3">
                <h4 class="mb-1"><i class="fas fa-graduation-cap"></i> Turon Admin</h4>
                <small class="text-white-50">AI Test Tizimi</small>
                <div class="mt-3">
                    <span class="badge bg-success" id="onlineCount">Online: 0</span>
                </div>
            </div>

            <div class="nav-links">
                <a href="#" class="nav-link-admin active" onclick="showAdminDashboard()">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>

                <a href="#" class="nav-link-admin ai" onclick="showAITestCreator()">
                    <i class="fas fa-robot"></i> AI Test Yaratish
                </a>

                <a href="#" class="nav-link-admin" onclick="showManualTestCreator()">
                    <i class="fas fa-edit"></i> O'zim Yaratish
                </a>

                <a href="#" class="nav-link-admin" onclick="showAdminTests()">
                    <i class="fas fa-list-alt"></i> Testlar
                </a>

                <a href="#" class="nav-link-admin" onclick="showLiveMonitoring()">
                    <i class="fas fa-desktop"></i> Live Monitoring
                </a>

                <a href="#" class="nav-link-admin" onclick="showScreenMirror()">
                    <i class="fas fa-video"></i> Screen Mirror
                </a>

                <a href="#" class="nav-link-admin" onclick="showAdminFiles()">
                    <i class="fas fa-file-upload"></i> Yuklangan Fayllar
                </a>

                <a href="#" class="nav-link-admin" onclick="showAdminStudents()">
                    <i class="fas fa-users"></i> O'quvchilar
                </a>

                <a href="#" class="nav-link-admin" onclick="showAdminResults()">
                    <i class="fas fa-chart-bar"></i> Natijalar
                </a>

                <a href="#" class="nav-link-admin" onclick="showAdminActivity()">
                    <i class="fas fa-history"></i> Faollik
                </a>
            </div>

            <hr class="text-white mx-3">

            <div class="px-3">
                <a href="#" class="nav-link-admin text-info" onclick="showStudentView()">
                    <i class="fas fa-exchange-alt"></i> O'quvchi sahifasi
                </a>

                <a href="#" class="nav-link-admin text-warning" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Chiqish
                </a>
            </div>

            <div class="mt-auto px-3 py-3">
                <small class="text-white-50 d-block">Version 2.0</small>
                <small class="text-white-50 d-block">Â© 2024 Turon O'quv Markazi</small>
            </div>
        </div>

        <div class="admin-content">
            <div id="adminContent">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Admin Login Modal -->
    <div class="modal fade" id="adminLoginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-lock"></i> Admin Kirish</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-shield fa-3x text-danger mb-3"></i>
                        <h4>Admin Panel</h4>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Telefon raqam</label>
                        <input type="text" class="form-control" id="adminPhone" placeholder="Admin login">
                    </div>

                    <div class="mb-3">
                        <div class="input-group">
                            <input type="password" class="form-control" id="adminPassword" placeholder="Admin parol">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="togglePassword('adminPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button class="btn btn-danger" onclick="loginAdmin()">
                            <i class="fas fa-sign-in-alt"></i> Admin Kirish
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Test Creator Modal -->
    <div class="modal fade" id="aiTestModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-ai text-white">
                    <h5 class="modal-title"><i class="fas fa-robot"></i> AI yordamida test yaratish</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="aiCreatorStep1">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">1. Ma\'lumot yuklash</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small">AI test savollarini yaratishi uchun matn yoki fayl
                                            yuklang.</p>

                                        <div class="mb-3">
                                            <label class="form-label">Mavzu yoki matn</label>
                                            <textarea id="aiSourceText" class="form-control" rows="8"
                                                placeholder="Masalan: O'zbekiston tarixi haqida 10 ta savol yarating..."></textarea>
                                        </div>

                                        <div class="text-center mb-3">
                                            <span class="text-muted">yoki</span>
                                        </div>

                                        <div id="aiDropZone" class="drop-zone"
                                            onclick="document.getElementById('aiFileInput').click()">
                                            <i class="fas fa-file-pdf fa-3x mb-3 text-danger"></i>
                                            <h5>Faylni tanlang yoki shu yerga tashlang</h5>
                                            <p class="text-muted small">PDF, DOCX yoki TXT (maks. 10MB)</p>
                                            <input type="file" id="aiFileInput" style="display:none"
                                                onchange="handleFileUpload(this)">
                                        </div>
                                        <div id="uploadedFileInfo" class="mt-3" style="display:none">
                                            <div
                                                class="alert alert-success d-flex justify-content-between align-items-center">
                                                <span id="fileName"></span>
                                                <button class="btn btn-sm btn-link text-danger"
                                                    onclick="removeUploadedFile()">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">2. Test sozlamalari</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Test nomi</label>
                                            <input type="text" id="aiTestTitle" class="form-control"
                                                placeholder="Masalan: Choraklik nazorat">
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="form-label">Savollar soni</label>
                                                <input type="number" id="aiCount" class="form-control" value="10"
                                                    min="1" max="50">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Vaqt (daqiqa)</label>
                                                <input type="number" id="aiTime" class="form-control" value="15"
                                                    min="5">
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Guruh kodi</label>
                                            <input type="text" id="aiGroup" class="form-control"
                                                placeholder="Masalan: 232">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Murakkablik darajasi</label>
                                            <select id="aiLevel" class="form-select">
                                                <option value="easy">Oson</option>
                                                <option value="medium" selected>O'rtacha</option>
                                                <option value="hard">Qiyin</option>
                                            </select>
                                        </div>

                                        <button class="btn btn-ai w-100 btn-lg mt-3" id="generateAIBtn"
                                            onclick="generateAITest()">
                                            <i class="fas fa-magic"></i> Testni generatsiya qilish
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="aiCreatorStep2" style="display:none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>AI tomonidan yaratilgan savollar</h5>
                            <div>
                                <button class="btn btn-outline-secondary me-2" onclick="backToStep1()">
                                    <i class="fas fa-arrow-left"></i> Qayta tahrirlash
                                </button>
                                <button class="btn btn-success" onclick="saveAITest()">
                                    <i class="fas fa-save"></i> Testni tasdiqlash va saqlash
                                </button>
                            </div>
                        </div>
                        <div id="aiGeneratedQuestions">
                            <!-- Questions Load Here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Test Creator Modal -->
    <div class="modal fade" id="manualTestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> O'zim test yaratish</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Test nomi</label>
                        <input type="text" id="manualTestTitle" class="form-control">
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Guruh kodi</label>
                            <input type="text" id="manualGroup" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vaqt (daqiqa)</label>
                            <input type="number" id="manualTime" class="form-control" value="20">
                        </div>
                    </div>
                    <hr>
                    <div id="manualQuestionsContainer">
                        <!-- Questins added here -->
                    </div>
                    <button class="btn btn-outline-primary mb-3" onclick="addManualQuestion()">
                        <i class="fas fa-plus"></i> Savol qo'shish
                    </button>
                    <div class="modal-footer px-0">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                        <button class="btn btn-primary" onclick="saveManualTest()">Saqlash</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-trash"></i> O'chirish</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage"></p>
                    <div class="alert alert-danger mt-3">
                        <i class="fas fa-exclamation-triangle"></i> Bu amalni ortga qaytarib bo'lmaydi!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">O'chirish</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div class="modal fade" id="testResultsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-chart-bar"></i> Test natijalari</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="testResultsContent">
                        <!-- Results Content -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen View Modal -->
    <div class="modal fade" id="screenViewModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-desktop"></i> O'quvchi ekrani</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-dark p-0">
                    <div id="screenViewContent" class="h-100">
                        <!-- Screen View Content -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Socket.io for Real-time Communication -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

    <!-- Main JavaScript Application -->
    <script>
        // ============================================
        // CONFIGURATION & GLOBAL VARIABLES
        // ============================================
        const CONFIG = {
            API_BASE_URL: '/api',
            SOCKET_URL: window.location.origin
        };

        let currentUser = null;
        let currentTest = null;
        let testTimer = null;
        let timeLeft = 0;
        let currentPage = '';
        let aiFileId = null;
        let socket = null;
        let onlineStudents = new Map();
        let screenMirrorData = new Map();
        let currentAITestQuestions = [];
        let monitoringInterval = null;

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Update active nav link
            if (sectionId === 'adminSection') {
                document.querySelectorAll('.nav-link-admin').forEach(link => {
                    link.classList.remove('active');
                });
            }
        }

        function showAdminLoginModal() {
            const modal = new bootstrap.Modal(document.getElementById('adminLoginModal'));
            modal.show();
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('uz-UZ') + ' ' + date.toLocaleTimeString('uz-UZ', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showAlert(message, type = 'info', duration = 5000) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                max-width: 500px;
            `;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alert);

            if (duration) {
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, duration);
            }
        }

        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="spinner-container">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
            }
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================

        function showLogin() {
            showSection('loginSection');
        }

        function showRegister() {
            showSection('registerSection');
        }

        function showStudentView() {
            showSection('loginSection');
        }

        async function loginStudent() {
            const phone = document.getElementById('studentPhone').value.trim();
            const password = document.getElementById('studentPassword').value;

            if (!phone || !password) {
                showAlert('Iltimos, telefon raqam va parolni kiriting', 'warning');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('current_user', JSON.stringify(currentUser));

                    // Connect to WebSocket
                    connectSocket();

                    document.getElementById('studentInfo').innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-2">
                                <i class="fas fa-user text-primary"></i>
                            </div>
                            <div>
                                <strong>${currentUser.firstName} ${currentUser.lastName}</strong><br>
                                <small class="text-muted"><i class="fas fa-users me-1"></i> ${currentUser.groupCode} guruhi o'quvchisi</small>
                            </div>
                        </div>
                    `;

                    showStudentTests();
                    showAlert('Muvaffaqiyatli kirildi', 'success');
                } else {
                    showAlert('Xatolik: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Server bilan ulanishda xatolik', 'danger');
                console.error('Login error:', error);
            }
        }

        async function loginAdmin() {
            const phone = document.getElementById('adminPhone').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('current_user', JSON.stringify(currentUser));

                    // Connect to WebSocket
                    connectSocket();

                    bootstrap.Modal.getInstance(document.getElementById('adminLoginModal')).hide();
                    showAdminDashboard();
                    showAlert('Admin panelga muvaffaqiyatli kirildi', 'success');
                } else {
                    showAlert('Xatolik: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Server bilan ulanishda xatolik', 'danger');
                console.error('Admin login error:', error);
            }
        }

        async function registerStudent() {
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const groupCode = document.getElementById('regGroup').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            // Validation
            if (!firstName || !lastName || !phone || !groupCode || !password || !confirmPassword) {
                showAlert('Iltimos, barcha maydonlarni to\'ldiring', 'warning');
                return;
            }

            if (password !== confirmPassword) {
                showAlert('Parollar mos kelmadi', 'danger');
                return;
            }

            if (password.length < 6) {
                showAlert('Parol kamida 6 ta belgidan iborat bo\'lishi kerak', 'danger');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firstName, lastName, phone, groupCode, password })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Muvaffaqiyatli ro\'yxatdan o\'tdingiz! Endi kirishingiz mumkin.', 'success');
                    showLogin();
                } else {
                    showAlert('Xatolik: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Server bilan ulanishda xatolik', 'danger');
                console.error('Registration error:', error);
            }
        }

        function logout() {
            if (confirm('Hisobingizdan chiqishni istaysizmi?')) {
                // Disconnect socket
                if (socket) {
                    socket.disconnect();
                }

                // Clear intervals
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                }

                currentUser = null;
                onlineStudents.clear();
                screenMirrorData.clear();
                localStorage.removeItem('current_user');
                showLogin();
                showAlert('Muvaffaqiyatli chiqildi', 'info');
            }
        }

        // ============================================
        // WEBSOCKET FUNCTIONS
        // ============================================

        function connectSocket() {
            if (!currentUser) return;

            // Disconnect existing socket
            if (socket) {
                socket.disconnect();
            }

            // Connect to WebSocket server
            socket = io(CONFIG.SOCKET_URL, {
                query: {
                    userId: currentUser.id,
                    userName: `${currentUser.firstName} ${currentUser.lastName}`,
                    role: currentUser.role,
                    groupCode: currentUser.groupCode
                }
            });

            socket.on('connect', () => {
                console.log('WebSocket connected:', socket.id);
                if (currentUser.role === 'admin') {
                    updateOnlineCount();
                }
            });

            socket.on('disconnect', () => {
                console.log('WebSocket disconnected');
            });

            socket.on('student_status_update', (data) => {
                updateStudentStatus(data);
            });

            socket.on('screen_mirror_update', (data) => {
                updateScreenMirror(data);
            });

            socket.on('test_submission', (data) => {
                if (currentUser.role === 'admin') {
                    showAlert(`${data.studentName} testni topshirdi: ${data.score}%`, 'info');
                }
            });

            socket.on('online_students', (data) => {
                onlineStudents = new Map(data.map(s => [s.id, s]));
                updateOnlineCount();
            });

            socket.on('error', (error) => {
                console.error('Socket error:', error);
            });
        }

        function updateStudentStatus(data) {
            if (currentUser.role !== 'admin') return;

            const { studentId, status, testId, progress } = data;

            // Update online students map
            if (!onlineStudents.has(studentId)) {
                onlineStudents.set(studentId, {
                    id: studentId,
                    name: data.studentName || 'Noma\'lum',
                    status: status,
                    lastUpdate: new Date()
                });
            } else {
                const student = onlineStudents.get(studentId);
                student.status = status;
                student.lastUpdate = new Date();
                if (data.studentName) student.name = data.studentName;
            }

            updateOnlineCount();

            // If monitoring page is active, refresh it
            if (currentPage === 'monitoring') {
                showLiveMonitoring();
            }
        }

        function updateScreenMirror(data) {
            if (currentUser.role !== 'admin') return;

            const { studentId, screenData, action } = data;

            if (action === 'clear') {
                screenMirrorData.delete(studentId);
            } else {
                screenMirrorData.set(studentId, {
                    ...data,
                    timestamp: new Date()
                });
            }

            // If screen mirror page is active, refresh it
            if (currentPage === 'screenMirror') {
                showScreenMirror();
            }
        }

        function updateOnlineCount() {
            const onlineCount = Array.from(onlineStudents.values()).filter(s =>
                s.status !== 'offline'
            ).length;

            document.getElementById('onlineCount').textContent = `Online: ${onlineCount}`;
        }

        // ============================================
        // STUDENT FUNCTIONS
        // ============================================

        async function showStudentTests() {
            showSection('studentSection');
            currentPage = 'studentTests';

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/tests/student/${currentUser.groupCode}`, {
                    headers: { 'user-id': currentUser.id }
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                const content = document.getElementById('studentContent');

                if (!data.tests || data.tests.length === 0) {
                    content.innerHTML = `
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3"></i>
                                <div>
                                    <h5 class="alert-heading">Testlar mavjud emas</h5>
                                    <p class="mb-0">Hozircha testlar mavjud emas. Ustozingiz yangi test qo'shguncha kuting.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3><i class="fas fa-list text-primary"></i> Mavjud testlar</h3>
                                    <p class="text-muted">Guruh: ${currentUser.groupCode}</p>
                                </div>
                                <div class="badge bg-primary">
                                    ${data.tests.length} ta test
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                `;

                data.tests.forEach(test => {
                    const now = new Date();
                    const startTime = new Date(test.startTime);
                    const endTime = new Date(test.endTime);
                    const isAvailable = now >= startTime && now <= endTime;
                    const isAITest = test.questions.some(q => q.createdByAI);

                    html += `
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="test-card h-100">
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge ${test.isTaken ? 'bg-secondary' : !isAvailable ? (now < startTime ? 'bg-warning' : 'bg-danger') : 'bg-success'}">
                                        ${test.isTaken ? 'â Topshirilgan' : !isAvailable ? (now < startTime ? 'â³ Kutilmoqda' : 'â Muddati o\'tgan') : 'â Mavjud'}
                                    </span>
                                </div>
                                
                                <div class="${isAITest ? 'ai-test-header' : 'test-header'}">
                                    <h5 class="mb-1">${test.title}</h5>
                                    ${test.description ? `<p class="small mb-0 opacity-75">${test.description}</p>` : ''}
                                    ${isAITest ? '<small class="d-block mt-1"><i class="fas fa-robot"></i> AI yaratgan test</small>' : ''}
                                </div>
                                
                                <div class="card-body d-flex flex-column">
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-question-circle text-primary me-2"></i>
                                            <span>${test.questions.length} savol</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-clock text-warning me-2"></i>
                                            <span>${test.timeLimit} daqiqa</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-star text-success me-2"></i>
                                            <span>${test.totalScore} ball</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-auto">
                                        ${test.isTaken ?
                            `<button class="btn btn-secondary w-100" disabled>
                                                <i class="fas fa-check-circle"></i> Topshirilgan
                                            </button>` :
                            !isAvailable ?
                                `<button class="btn btn-outline-secondary w-100" disabled>
                                                <i class="fas fa-lock"></i> ${now < startTime ? 'Hali boshlanmadi' : 'Muddati o\'tgan'}
                                            </button>` :
                                `<button class="btn btn-primary w-100" onclick="startTest('${test._id}')">
                                                <i class="fas fa-play-circle"></i> Testni boshlash
                                            </button>`
                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                content.innerHTML = html;

            } catch (error) {
                console.error('Error loading tests:', error);
                document.getElementById('studentContent').innerHTML = `
                    <div class="alert alert-danger">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                            <div>
                                <h5 class="alert-heading">Xatolik yuz berdi</h5>
                                <p class="mb-0">Testlarni yuklashda xatolik. Iltimos, qayta urinib ko'ring.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        async function startTest(testId) {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/tests/take/${testId}`, {
                    headers: { 'user-id': currentUser.id }
                });

                const data = await response.json();

                if (!data.success) {
                    showAlert('Xatolik: ' + data.error, 'danger');
                    return;
                }

                currentTest = data.test;
                timeLeft = currentTest.timeLimit * 60;

                const content = document.getElementById('studentContent');
                content.innerHTML = `
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div>
                                    <h3>${currentTest.title}</h3>
                                    <p class="text-muted mb-0">${currentTest.description || ''}</p>
                                    ${currentTest.questions.some(q => q.createdByAI) ?
                        '<span class="badge badge-ai mt-2"><i class="fas fa-robot"></i> AI testi</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex justify-content-end">
                                <div class="timer">
                                    <div id="testTimer">
                                        ${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}
                                    </div>
                                    <small class="d-block text-center text-muted mt-1">Qolgan vaqt</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Testda ${currentTest.questions.length} ta savol bor. Har bir savolga javob bering.
                    </div>
                    
                    <div id="testQuestionsContainer">
                        <!-- Questions will be loaded here -->
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body text-center">
                                    <button class="btn btn-success btn-lg px-5 me-3" onclick="submitTest()">
                                        <i class="fas fa-paper-plane"></i> Testni yakunlash
                                    </button>
                                    <button class="btn btn-outline-danger btn-lg px-5" onclick="cancelTest()">
                                        <i class="fas fa-times"></i> Bekor qilish
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Load questions
                const container = document.getElementById('testQuestionsContainer');
                currentTest.questions.forEach((question, index) => {
                    container.innerHTML += `
                        <div class="${question.createdByAI ? 'question-box ai-question-box' : 'question-box'}">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="mb-0">${index + 1}. ${question.text}</h5>
                                <span class="badge bg-success">${question.score || 5} ball</span>
                            </div>
                            <div class="options">
                                ${question.options.map((option, optIndex) => `
                                    <label class="option-label" onclick="selectOption(this, ${index}, '${option}')">
                                        <input type="radio" name="q${index}" value="${option}" style="display:none;">
                                        <span class="me-2">${String.fromCharCode(65 + optIndex)})</span>
                                        ${option}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                // Start timer
                startTimer();

                // Notify admin about test start
                if (socket) {
                    socket.emit('test_started', {
                        studentId: currentUser.id,
                        studentName: `${currentUser.firstName} ${currentUser.lastName}`,
                        testId: testId,
                        testTitle: currentTest.title
                    });
                }

            } catch (error) {
                console.error('Error starting test:', error);
                showAlert('Testni boshlashda xatolik', 'danger');
            }
        }

        function selectOption(element, questionIndex, optionValue) {
            const questionBox = element.closest('.question-box');
            questionBox.querySelectorAll('.option-label').forEach(label => {
                label.classList.remove('selected');
            });
            element.classList.add('selected');

            if (!currentTest.answers) {
                currentTest.answers = {};
            }
            currentTest.answers[questionIndex] = optionValue;

            // Send screen update for mirroring
            if (socket) {
                socket.emit('screen_update', {
                    studentId: currentUser.id,
                    action: 'answer_selected',
                    questionIndex: questionIndex,
                    selectedOption: optionValue,
                    testId: currentTest._id
                });
            }
        }

        function startTimer() {
            clearInterval(testTimer);

            testTimer = setInterval(() => {
                timeLeft--;

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('testTimer').textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;

                // Update progress bar in monitoring
                if (socket) {
                    const progress = ((currentTest.timeLimit * 60) - timeLeft) / (currentTest.timeLimit * 60) * 100;
                    socket.emit('test_progress', {
                        studentId: currentUser.id,
                        progress: progress,
                        timeLeft: timeLeft
                    });
                }

                if (timeLeft <= 0) {
                    clearInterval(testTimer);
                    submitTest();
                }
            }, 1000);
        }

        async function submitTest() {
            clearInterval(testTimer);

            // Check if all questions answered
            const answeredCount = currentTest.answers ? Object.keys(currentTest.answers).length : 0;
            const totalQuestions = currentTest.questions.length;

            if (answeredCount < totalQuestions) {
                if (!confirm(`${totalQuestions - answeredCount} ta savolga javob bermadingiz. Testni shu holatda topshirishni istaysizmi?`)) {
                    return;
                }
            }

            // Prepare answers array
            const answers = [];
            for (let i = 0; i < currentTest.questions.length; i++) {
                answers.push(currentTest.answers?.[i] || '');
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/tests/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'user-id': currentUser.id
                    },
                    body: JSON.stringify({
                        testId: currentTest._id,
                        answers: answers,
                        timeTaken: (currentTest.timeLimit * 60) - timeLeft
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Notify admin about submission
                    if (socket) {
                        socket.emit('test_submitted', {
                            studentId: currentUser.id,
                            studentName: `${currentUser.firstName} ${currentUser.lastName}`,
                            testId: currentTest._id,
                            testTitle: currentTest.title,
                            score: data.score,
                            percentage: data.percentage,
                            passed: data.passed
                        });
                    }

                    showTestResult(data);
                } else {
                    showAlert('Xatolik: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Error submitting test:', error);
                showAlert('Testni topshirishda xatolik', 'danger');
            }
        }

        function showTestResult(result) {
            const content = document.getElementById('studentContent');

            // Determine result color and icon
            const statusColor = result.passed ? 'success' : 'danger';
            const statusIcon = result.passed ? 'fa-check-circle' : 'fa-times-circle';

            // Grade visualization
            let gradeHtml = '';
            if (result.grade >= 2) {
                const gradeLabels = { 5: 'A', 4: 'B', 3: 'C', 2: 'D' };
                gradeHtml = `
                    <div class="grade-badge grade-${result.grade}">
                        <i class="fas fa-award grade-icon"></i>
                        Baho: ${result.grade} (${gradeLabels[result.grade]})
                    </div>
                `;
            } else {
                gradeHtml = `
                    <div class="grade-badge grade-2">
                        <i class="fas fa-exclamation-circle grade-icon"></i>
                        Baho: ${result.grade || 0}
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="row justify-content-center">
                    <div class="col-md-10 col-lg-8">
                        <div class="result-card">
                            <div class="mb-4">
                                ${gradeHtml}
                                <h2 class="fw-bold"><i class="fas ${statusIcon} text-${statusColor}"></i> 
                                    ${result.passed ? 'Tabriklaymiz!' : 'Yana urinib ko\'ring!'}
                                </h2>
                                <p class="text-muted">Test muvaffaqiyatli topshirildi</p>
                            </div>
                            
                            <div class="score-circle" style="--percentage: ${result.percentage}%" data-score="${result.percentage}%">
                                <span>${result.percentage}%</span>
                            </div>
                            
                            <h3 class="mb-4 text-primary">${currentTest.title}</h3>
                            
                            <div class="row mt-4 g-3">
                                <div class="col-md-4">
                                    <div class="p-3 rounded-4 bg-light border border-white">
                                        <small class="text-muted d-block mb-1">Olingan ball</small>
                                        <h4 class="mb-0 fw-bold text-success">${result.score}/${result.totalScore}</h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 rounded-4 bg-light border border-white">
                                        <small class="text-muted d-block mb-1">Holati</small>
                                        <h4 class="mb-0 fw-bold text-${statusColor}">
                                            ${result.passed ? "O'tdi" : "O'tmadi"}
                                        </h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 rounded-4 bg-light border border-white">
                                        <small class="text-muted d-block mb-1">Sarflangan vaqt</small>
                                        <h4 class="mb-0 fw-bold text-primary">${Math.floor(result.timeTaken / 60)}m ${result.timeTaken % 60}s</h4>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-5 d-flex gap-3 justify-content-center">
                                <button class="btn btn-primary btn-lg rounded-pill px-4" onclick="showStudentTests()">
                                    <i class="fas fa-home me-2"></i> Bosh sahifa
                                </button>
                                <button class="btn btn-outline-dark btn-lg rounded-pill px-4" onclick="showStudentResults()">
                                    <i class="fas fa-chart-bar me-2"></i> Natijalarim
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            currentTest = null;
        }

        function cancelTest() {
            if (confirm('Testni bekor qilishni istaysizmi? Barcha javoblar saqlanmaydi.')) {
                clearInterval(testTimer);
                currentTest = null;
                showStudentTests();
            }
        }

        async function showStudentResults() {
            showSection('studentSection');
            currentPage = 'studentResults';

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/results/student`, {
                    headers: { 'user-id': currentUser.id }
                });

                const data = await response.json();

                const content = document.getElementById('studentContent');

                if (!data.success || !data.results || data.results.length === 0) {
                    content.innerHTML = `
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3"></i>
                                <div>
                                    <h5 class="alert-heading">Natijalar mavjud emas</h5>
                                    <p class="mb-0">Hozircha siz hech qanday test topshirmagansiz.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3><i class="fas fa-chart-bar text-success"></i> Mening natijalarim</h3>
                                    <p class="text-muted">Jami ${data.results.length} ta natija</p>
                                </div>
                                <button class="btn btn-outline-primary" onclick="showStudentTests()">
                                    <i class="fas fa-arrow-left"></i> Testlarga qaytish
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Test nomi</th>
                                    <th>Ball</th>
                                    <th>Foiz</th>
                                    <th>Natija</th>
                                    <th>Vaqt</th>
                                    <th>Sana</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.results.forEach((result, index) => {
                    const timeTaken = Math.round(result.timeTaken / 60);

                    html += `
                        <tr class="cursor-pointer" onclick="viewResultDetails('${result._id}')">
                            <td>${index + 1}</td>
                            <td>${result.testId?.title || 'Noma\'lum test'}</td>
                            <td><strong>${result.score}/${result.totalScore}</strong></td>
                            <td>
                                <span class="badge ${result.percentage >= 60 ? 'bg-success' : 'bg-danger'}">
                                    ${result.percentage}%
                                </span>
                            </td>
                            <td>
                                <span class="badge ${result.passed ? 'bg-success' : 'bg-danger'}">
                                    ${result.passed ? "O'tdi" : "O'tmadi"}
                                </span>
                            </td>
                            <td>${timeTaken} daqiqa</td>
                            <td>${formatDate(result.submittedAt)}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <div class="card">
                            <div class="card-body">
                                <h5>Statistika</h5>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <div class="stat-card">
                                            <h6>O'rtacha ball</h6>
                                            <h3>${calculateAverage(data.results)}%</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card">
                                            <h6>O'tgan testlar</h6>
                                            <h3>${data.results.filter(r => r.passed).length}</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card">
                                            <h6>Jami ball</h6>
                                            <h3>${data.results.reduce((sum, r) => sum + r.score, 0)}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                content.innerHTML = html;

            } catch (error) {
                console.error('Error loading results:', error);
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                            <div>
                                <h5 class="alert-heading">Xatolik yuz berdi</h5>
                                <p class="mb-0">Natijalarni yuklashda xatolik. Iltimos, qayta urinib ko'ring.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function calculateAverage(results) {
            if (results.length === 0) return 0;
            const total = results.reduce((sum, r) => sum + r.percentage, 0);
            return Math.round(total / results.length);
        }

        async function viewResultDetails(resultId) {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/results/${resultId}`, {
                    headers: { 'user-id': currentUser.id }
                });

                const data = await response.json();

                if (data.success) {
                    const modal = new bootstrap.Modal(document.getElementById('testResultsModal'));
                    const content = document.getElementById('testResultsContent');

                    content.innerHTML = `
                        <h4>Test natijasi: ${data.result.testId?.title || 'Noma\'lum'}</h4>
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Umumiy ball</h6>
                                        <h3>${data.result.score}/${data.result.totalScore}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Foiz</h6>
                                        <h3 class="${data.result.percentage >= 60 ? 'text-success' : 'text-danger'}">
                                            ${data.result.percentage}%
                                        </h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Natija</h6>
                                        <h3>
                                            <span class="badge ${data.result.passed ? 'bg-success' : 'bg-danger'}">
                                                ${data.result.passed ? "O'tdi" : "O'tmadi"}
                                            </span>
                                        </h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Vaqt</h6>
                                        <h3>${Math.round(data.result.timeTaken / 60)} daq</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h5>Savol natijalari</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Savol</th>
                                        <th>Sizning javobi</th>
                                        <th>To'g'ri javob</th>
                                        <th>Ball</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.result.answers.map((answer, index) => `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${answer.question || 'Noma\'lum'}</td>
                                            <td>
                                                <span class="${answer.isCorrect ? 'text-success' : 'text-danger'}">
                                                    ${answer.selected || 'Javob berilmagan'}
                                                    ${answer.isCorrect ? ' â' : ' â'}
                                                </span>
                                            </td>
                                            <td>${answer.correct}</td>
                                            <td>${answer.score}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;

                    modal.show();
                }
            } catch (error) {
                console.error('Error loading result details:', error);
                showAlert('Natija tafsilotlarini yuklashda xatolik', 'danger');
            }
        }

        // ============================================
        // ADMIN FUNCTIONS
        // ============================================

        async function showAdminDashboard() {
            showSection('adminSection');
            currentPage = 'adminDashboard';

            // Update active nav
            document.querySelectorAll('.nav-link-admin').forEach(link => {
                link.classList.remove('active');
            });
            // Find the dashboard link and make it active
            const dashboardLink = document.querySelector('a[onclick="showAdminDashboard()"]');
            if (dashboardLink) dashboardLink.classList.add('active');

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/admin/dashboard`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                const content = document.getElementById('adminContent');
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1"><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
                            <p class="text-muted mb-0">Tizim statistikasi va boshqaruv paneli</p>
                        </div>
                        <div class="badge bg-primary">
                            ${new Date().toLocaleDateString('uz-UZ')}
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                                        <i class="fas fa-users text-primary fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-muted mb-1">O'quvchilar</h6>
                                        <h2 class="mb-0">${data.stats.students}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
                                        <i class="fas fa-list-alt text-success fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-muted mb-1">Testlar</h6>
                                        <h2 class="mb-0">${data.stats.tests}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-info bg-opacity-10 p-3 rounded-circle me-3">
                                        <i class="fas fa-chart-bar text-info fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-muted mb-1">Natijalar</h6>
                                        <h2 class="mb-0">${data.stats.results}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="ai-stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="bg-ai bg-opacity-10 p-3 rounded-circle me-3">
                                        <i class="fas fa-robot text-ai fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-muted mb-1">AI Fayllar</h6>
                                        <h2 class="mb-0">${data.stats.files}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-history"></i> So'nggi faollik</h5>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    ${data.recentActivities.length ? data.recentActivities.map(activity => `
                                        <div class="border-bottom pb-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong>${activity.userName || 'Noma\'lum'}</strong>
                                                    <div class="text-muted small">
                                                        ${getActivityIcon(activity.activity)} 
                                                        ${getActivityText(activity.activity)}
                                                    </div>
                                                </div>
                                                <small class="text-muted">${formatDate(activity.timestamp)}</small>
                                            </div>
                                            ${activity.testTitle ? `
                                                <div class="mt-2">
                                                    <small class="text-muted">Test:</small>
                                                    <div class="text-truncate">${activity.testTitle}</div>
                                                </div>
                                            ` : ''}
                                            ${activity.score ? `
                                                <div class="mt-1">
                                                    <small class="text-muted">Natija:</small>
                                                    <span class="badge ${activity.score >= 60 ? 'bg-success' : 'bg-danger'}">
                                                        ${activity.score}%
                                                    </span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('') : '<p class="text-muted text-center">Faolliklar mavjud emas</p>'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Tezkor harakatlar</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-3">
                                        <button class="btn btn-ai" onclick="showAITestCreator()">
                                            <i class="fas fa-robot"></i> AI yordamida test yaratish
                                        </button>
                                        <button class="btn btn-primary" onclick="showManualTestCreator()">
                                            <i class="fas fa-edit"></i> O'zim test yaratish
                                        </button>
                                        <button class="btn btn-success" onclick="showLiveMonitoring()">
                                            <i class="fas fa-desktop"></i> Live Monitoring
                                        </button>
                                        <button class="btn btn-info" onclick="showAdminStudents()">
                                            <i class="fas fa-users"></i> O'quvchilarni ko'rish
                                        </button>
                                        <button class="btn btn-warning" onclick="showAdminResults()">
                                            <i class="fas fa-chart-bar"></i> Barcha natijalar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Bugungi statistikalar</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="bg-success bg-opacity-10 p-2 rounded me-3">
                                                    <i class="fas fa-check-circle text-success"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1">Bugun topshirilgan</h6>
                                                    <h4 class="mb-0">${data.stats.todayResults || 0}</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="bg-primary bg-opacity-10 p-2 rounded me-3">
                                                    <i class="fas fa-user-clock text-primary"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1">Online o'quvchilar</h6>
                                                    <h4 class="mb-0" id="dashboardOnlineCount">0</h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Update online count
                const onlineCount = Array.from(onlineStudents.values()).filter(s =>
                    s.status !== 'offline'
                ).length;
                document.getElementById('dashboardOnlineCount').textContent = onlineCount;

            } catch (error) {
                console.error('Error loading dashboard:', error);
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                            <div>
                                <h5 class="alert-heading">Dashboard yuklanmadi</h5>
                                <p class="mb-0">Server bilan ulanishda xatolik. Iltimos, qayta urinib ko'ring.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function getActivityIcon(activity) {
            switch (activity) {
                case 'admin_login': return 'ð';
                case 'student_login': return 'ð¤';
                case 'test_started': return 'ð';
                case 'test_completed': return 'â';
                case 'test_created_from_ai': return 'ð¤';
                case 'test_created_manual': return 'âï¸';
                case 'registration': return 'ð';
                default: return 'ð';
            }
        }

        function getActivityText(activity) {
            switch (activity) {
                case 'admin_login': return 'Admin kirishi';
                case 'student_login': return 'O\'quvchi kirishi';
                case 'test_started': return 'Testni boshlash';
                case 'test_completed': return 'Testni tugatish';
                case 'test_created_from_ai': return 'AI test yaratish';
                case 'test_created_manual': return 'Test yaratish';
                case 'registration': return 'Ro\'yxatdan o\'tish';
                default: return activity;
            }
        }

        // ============================================
        // ADMIN PAGE IMPLEMENTATIONS
        // ============================================

        async function showAITestCreator() {
            const modal = new bootstrap.Modal(document.getElementById('aiTestModal'));
            document.getElementById('aiCreatorStep1').style.display = 'block';
            document.getElementById('aiCreatorStep2').style.display = 'none';
            modal.show();
        }

        let uploadedText = "";

        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const dropZone = document.getElementById('aiDropZone');
            const originalHTML = dropZone.innerHTML;

            dropZone.innerHTML = '<span class="spinner-border text-danger"></span> Fayl o\'qilmoqda...';

            const formData = new FormData();
            formData.append('file', file);

            try {
                let endpoint = '/api/admin/ai/parse-pdf';
                const response = await fetch(`${CONFIG.API_BASE_URL.replace('/api', '')}${endpoint}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    uploadedText = data.text;
                    document.getElementById('uploadedFileInfo').style.display = 'block';
                    document.getElementById('fileName').textContent = file.name + ' (Matn o\'qildi)';
                    showAlert('Fayl muvaffaqiyatli tahlil qilindi', 'success');
                } else {
                    showAlert('Faylni o\'qishda xatolik: ' + data.error, 'danger');
                }
            } catch (e) {
                showAlert('Server bilan ulanishda xatolik', 'danger');
            } finally {
                dropZone.innerHTML = originalHTML;
            }
        }

        async function generateAITest() {
            const topic = document.getElementById('aiSourceText').value;
            const title = document.getElementById('aiTestTitle').value;
            const count = document.getElementById('aiCount').value;
            const level = document.getElementById('aiLevel').value;

            if (!topic && !uploadedText) {
                showAlert('Iltimos, mavzu kiriting yoki fayl yuklang', 'warning');
                return;
            }

            const btn = document.getElementById('generateAIBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> AI savollarni yaratmoqda...';

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/admin/ai/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic,
                        count,
                        level,
                        sourceText: uploadedText
                    })
                });

                const data = await response.json();

                if (data.success) {
                    renderAIGeneratedQuestions(data.questions);
                    document.getElementById('aiCreatorStep1').style.display = 'none';
                    document.getElementById('aiCreatorStep2').style.display = 'block';
                    showAlert('Savollar yaratildi! Tekshirib chiqing va saqlang.', 'success');
                } else {
                    showAlert('AI Xatosi: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Server bilan ulanishda xatolik', 'danger');
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Testni generatsiya qilish';
            }
        }

        function renderAIGeneratedQuestions(questions) {
            currentAITestQuestions = questions;
            const container = document.getElementById('aiGeneratedQuestions');
            container.innerHTML = questions.map((q, i) => `
                <div class="card mb-3 border-ai">
                    <div class="card-body">
                        <h6>${i + 1}. <input type="text" class="form-control d-inline-block w-75" value="${q.text}" onchange="updateAIQuestion(${i}, 'text', this.value)"></h6>
                        <div class="row mt-2">
                            ${q.options.map((opt, oi) => `
                                <div class="col-md-6 mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text">${String.fromCharCode(65 + oi)}</span>
                                        <input type="text" class="form-control" value="${opt}" onchange="updateAIQuestion(${i}, 'option', this.value, ${oi})">
                                        <div class="input-group-text">
                                            <input type="radio" name="correct_${i}" ${opt === q.correctAnswer ? 'checked' : ''} onchange="updateAIQuestion(${i}, 'correct', '${opt}')">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function saveAITest() {
            const title = document.getElementById('aiTestTitle').value;
            const groupCode = document.getElementById('aiGroup').value;
            const timeLimit = document.getElementById('aiTime').value;

            if (!title || !groupCode) {
                showAlert('Sarlavha va guruh kodini kiriting', 'warning');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/admin/tests/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'user-id': currentUser.id },
                    body: JSON.stringify({
                        title, groupCode, timeLimit,
                        questions: currentAITestQuestions
                    })
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('Test muvaffaqiyatli saqlandi', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('aiTestModal')).hide();
                    showAdminTests();
                }
            } catch (e) {
                showAlert('Saqlashda xatolik', 'danger');
            }
        }

        function showManualTestCreator() {
            const modal = new bootstrap.Modal(document.getElementById('manualTestModal'));
            document.getElementById('manualQuestionsContainer').innerHTML = '';
            addManualQuestion();
            modal.show();
        }

        function addManualQuestion() {
            const container = document.getElementById('manualQuestionsContainer');
            const qIndex = container.children.length;
            const html = `
                <div class="card mb-3 question-entry">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5>Savol #${qIndex + 1}</h5>
                            <button class="btn btn-sm btn-danger" onclick="this.closest('.question-entry').remove()"><i class="fas fa-trash"></i></button>
                        </div>
                        <input type="text" class="form-control mb-2 q-text" placeholder="Savol matni">
                        <div class="row">
                            <div class="col-6 mb-2"><input type="text" class="form-control q-opt" placeholder="Variant A"></div>
                            <div class="col-6 mb-2"><input type="text" class="form-control q-opt" placeholder="Variant B"></div>
                            <div class="col-6 mb-2"><input type="text" class="form-control q-opt" placeholder="Variant C"></div>
                            <div class="col-6 mb-2"><input type="text" class="form-control q-opt" placeholder="Variant D"></div>
                        </div>
                        <select class="form-select q-correct">
                            <option value="0">To'g'ri javob: A</option>
                            <option value="1">To'g'ri javob: B</option>
                            <option value="2">To'g'ri javob: C</option>
                            <option value="3">To'g'ri javob: D</option>
                        </select>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        async function saveManualTest() {
            const title = document.getElementById('manualTestTitle').value;
            const groupCode = document.getElementById('manualGroup').value;
            const timeLimit = document.getElementById('manualTime').value;

            const questions = [];
            document.querySelectorAll('.question-entry').forEach(el => {
                const opts = Array.from(el.querySelectorAll('.q-opt')).map(i => i.value);
                questions.push({
                    text: el.querySelector('.q-text').value,
                    options: opts,
                    correctAnswer: opts[el.querySelector('.q-correct').value],
                    score: 5
                });
            });

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/admin/tests/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'user-id': currentUser.id },
                    body: JSON.stringify({ title, groupCode, timeLimit, questions })
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('Test yaratildi', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('manualTestModal')).hide();
                    showAdminTests();
                }
            } catch (e) { showAlert('Xatolik', 'danger'); }
        }

        async function showAdminTests() {
            showSection('adminSection');
            currentPage = 'adminTests';
            const res = await fetch(`${CONFIG.API_BASE_URL}/admin/tests`);
            const data = await res.json();

            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-list-alt"></i> Barcha testlar</h3>
                    <button class="btn btn-primary" onclick="showManualTestCreator()">+ Yangi test</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover bg-white rounded shadow-sm">
                        <thead><tr><th>Nomi</th><th>Guruh</th><th>Savollar</th><th>Vaqt</th><th>Amallar</th></tr></thead>
                        <tbody>
                            ${data.tests.map(t => `
                                <tr>
                                    <td>${t.title}</td>
                                    <td><span class="badge bg-info">${t.groupCode}</span></td>
                                    <td>${t.questions.length} ta</td>
                                    <td>${t.timeLimit} daq</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteTest('${t._id}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function deleteTest(id) {
            if (confirm('Ushbu testni va uning barcha natijalarini o\'chirmoqchimisiz?')) {
                await fetch(`${CONFIG.API_BASE_URL}/admin/tests/${id}`, { method: 'DELETE' });
                showAdminTests();
            }
        }

        async function showLiveMonitoring() {
            showSection('adminSection');
            currentPage = 'monitoring';
            const res = await fetch(`${CONFIG.API_BASE_URL}/admin/dashboard`);
            const data = await res.json();

            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <h3><i class="fas fa-desktop"></i> Live Monitoring</h3>
                <div class="row mt-4" id="monitorGrid">
                    ${Array.from(onlineStudents.values()).map(s => `
                        <div class="col-md-4">
                            <div class="student-monitor ${s.status === 'testing' ? 'active' : ''}">
                                <div class="d-flex justify-content-between">
                                    <strong>${s.name}</strong>
                                    <span class="badge ${s.status === 'testing' ? 'bg-success' : 'bg-primary'}">${s.status}</span>
                                </div>
                                <small class="text-muted">Guruh: ${s.groupCode || 'Noma\'lum'}</small>
                                ${s.currentTest ? `<div class="mt-2 small text-primary">${s.currentTest}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showScreenMirror() {
            showSection('adminSection');
            currentPage = 'screenMirror';
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <h3><i class="fas fa-video"></i> Screen Mirror</h3>
                <div class="screen-grid">
                    ${Array.from(screenMirrorData.values()).map(sm => `
                        <div class="screen-item">
                            <div class="screen-header">${sm.studentName}</div>
                            <div class="screen-content">
                                Action: ${sm.action}<br>
                                Question: ${sm.questionIndex + 1}<br>
                                Answer: ${sm.selectedOption}
                            </div>
                        </div>
                    `).join('')}
                    ${screenMirrorData.size === 0 ? '<p class="text-muted">Ayni damda hech kim test yechmayapti</p>' : ''}
                </div>
            `;
        }

        async function showAdminStudents() {
            currentPage = 'adminStudents';
            const res = await fetch(`${CONFIG.API_BASE_URL}/admin/students`);
            const data = await res.json();
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <h3><i class="fas fa-users"></i> O'quvchilar</h3>
                <table class="table table-hover bg-white mt-3">
                    <thead><tr><th>Ism Familiya</th><th>Telefon</th><th>Guruh</th><th>Sana</th></tr></thead>
                    <tbody>
                        ${data.students.map(s => `<tr><td>${s.firstName} ${s.lastName}</td><td>${s.phone}</td><td>${s.groupCode}</td><td>${formatDate(s.createdAt)}</td></tr>`).join('')}
                    </tbody>
                </table>
            `;
        }

        async function showAdminResults() {
            currentPage = 'adminResults';
            const res = await fetch(`${CONFIG.API_BASE_URL}/admin/results`);
            const data = await res.json();
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <h3><i class="fas fa-chart-bar"></i> Barcha natijalar</h3>
                <table class="table table-hover bg-white mt-3">
                    <thead><tr><th>O'quvchi</th><th>Test</th><th>Ball</th><th>Foiz</th><th>Sana</th></tr></thead>
                    <tbody>
                        ${data.results.map(r => `<tr><td>${r.userId?.firstName} ${r.userId?.lastName}</td><td>${r.testId?.title}</td><td>${r.score}/${r.totalScore}</td><td>${r.percentage}%</td><td>${formatDate(r.submittedAt)}</td></tr>`).join('')}
                    </tbody>
                </table>
            `;
        }

        async function showAdminActivity() {
            currentPage = 'adminActivity';
            const res = await fetch(`${CONFIG.API_BASE_URL}/admin/activities`);
            const data = await res.json();
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <h3><i class="fas fa-history"></i> Tizim faolligi</h3>
                <div class="card mt-3"><div class="card-body">
                    ${data.activities.map(a => `<div class="border-bottom py-2"><strong>${a.userName}</strong>: ${getActivityText(a.activity)} <small class="text-muted float-end">${formatDate(a.timestamp)}</small></div>`).join('')}
                </div></div>
            `;
        }

        async function showAdminFiles() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `<h3><i class="fas fa-file-upload"></i> Yuklangan fayllar</h3><p class="text-muted">Bu bo'limda serverdagi fayllar ro'yxati bo'ladi.</p>`;
        }
        function updateAIQuestion(qIndex, field, value, optIndex = null) {
            if (field === 'text') {
                currentAITestQuestions[qIndex].text = value;
            } else if (field === 'option') {
                currentAITestQuestions[qIndex].options[optIndex] = value;
            } else if (field === 'correct') {
                currentAITestQuestions[qIndex].correctAnswer = value;
            }
        }

        function removeUploadedFile() {
            aiFileId = null;
            document.getElementById('aiFileInput').value = '';
            document.getElementById('uploadedFileInfo').style.display = 'none';
        }

        function backToStep1() {
            document.getElementById('aiCreatorStep1').style.display = 'block';
            document.getElementById('aiCreatorStep2').style.display = 'none';
        }

        // Real DeepSeek Integration
        async function callDeepSeek(prompt) {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        { role: "system", content: "You are a professional teacher. Create multiple choice questions in Uzbek. Return ONLY valid JSON array." },
                        { role: "user", content: prompt }
                    ],
                    response_format: { type: 'json_object' }
                })
            });
            return await response.json();
        }
    </script>
</body>

</html>